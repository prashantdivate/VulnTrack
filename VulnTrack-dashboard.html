<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Yocto CVE Report (Local)</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="h-left">
      <div class="h-title">
        <span class="appTitle" id="reportTitle">VulnTrack Report</span>
        <div class="compatibility-badges">
          <span class="badge">
            <img src="https://www.yoctoproject.org/wp-content/uploads/sites/32/2023/09/YoctoProject_Logo_RGB_White_small.svg" alt="Yocto Logo" height="30">
            Compatible
            </span>
        </div>
      </div>
      <div class="h-sub">
        <span id="createdLine">Report generated: —</span>
        <span id="pkgLine">Packages: —</span>
        <span id="issueLine">Issues: —</span>
      </div>
    </div>

    <div class="actions">
      <label class="btn" for="file">Choose JSON</label>
      <input id="file" type="file" accept=".json,application/json"/>
      <button class="btn" id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="chipbar" id="chipbar">
    <span class="chip">Load <strong>cve-summary.json</strong> to view</span>
  </div>

  <!-- Tabs (removed: IoC/History/TTPs/Reporting/Community) -->
  <div class="tabs">
    <div class="tab active" data-page="summary">Summary</div>
    <div class="tab" data-page="packages">Packages</div>
    <div class="tab" data-page="issues">Issues</div>
    <div class="tab" data-page="sources">Sources</div>
    <div class="tab" data-page="products">Products & Fixes</div>
  </div>
</header>

<main>

  <!-- ===== Summary ===== -->
  <section class="page active" id="page-summary">
    <div class="grid2">
      <div class="panel">
        <h3 class="panel-title">Summary & Analysis</h3>
        <div class="muted" id="execSummary">
          Load a Yocto <code>cve-summary.json</code> (local). This report summarizes package vulnerabilities found during your build.
        </div>

        <div style="height:12px"></div>

        <h3 class="panel-title">Details</h3>
        <div class="kvgrid">
          <div class="kv"><div class="k">Build schema version</div><div class="v" id="schemaV">—</div></div>
          <div class="kv"><div class="k">Affected packages</div><div class="v" id="affPkgs">—</div></div>
          <div class="kv"><div class="k">Total CVE issues</div><div class="v" id="totalIssues">—</div></div>
          <div class="kv"><div class="k">Unpatched / Ignored</div><div class="v" id="openIssues">—</div></div>
        </div>

        <div style="height:14px"></div>

        <h3 class="panel-title">Top CVEs (by severity)</h3>
        <div class="tableWrap">
          <table class="tableTight">
            <thead>
              <tr>
                <th style="width:160px">CVE</th>
                <th style="width:140px">Severity</th>
                <th>Summary</th>
                <th style="width:120px">Status</th>
              </tr>
            </thead>
            <tbody id="topCvesBody"></tbody>
          </table>
        </div>

        <div class="muted tipLine">
          Tip: Click any CVE to open the detailed CVE info (Yocto + NVD + EPSS).
        </div>
      </div>

      <div class="panel">
        <h3 class="panel-title">Priority Visualization</h3>
        <div class="chartWrap"><canvas id="sevChart"></canvas></div>

        <div style="height:14px"></div>

        <h3 class="panel-title">Vulnerable Packages</h3>
        <div class="chartWrap"><canvas id="pkgChart"></canvas></div>

        <div style="height:14px"></div>

        <h3 class="panel-title">CVSS Snapshot</h3>
        <div class="kvgrid">
          <div class="kv"><div class="k">Highest CVSS v3</div><div class="v" id="maxCvss3">—</div></div>
          <div class="kv"><div class="k">Highest CVSS v2</div><div class="v" id="maxCvss2">—</div></div>
          <div class="kv"><div class="k">Most common vector</div><div class="v" id="commonVector">—</div></div>
          <div class="kv"><div class="k">Notes</div><div class="v" style="font-weight:700;color:var(--muted)">Yocto JSON does not include EPSS/KEV/exploit info by default.</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Products & Fixes ===== -->
  <section class="page" id="page-products">
    <div class="panel">
      <h3 class="panel-title">Products & Fixes</h3>
      <div class="muted">
        Derived locally from Yocto package name/version/layer + issue status (Patched / Unpatched / Ignored).
      </div>

      <div style="height:12px"></div>

      <div class="tableWrap">
        <table class="tableTight">
          <thead>
            <tr>
              <th style="width:240px">Package</th>
              <th style="width:120px">Version</th>
              <th style="width:220px">Layer</th>
              <th style="width:140px">Worst status</th>
              <th>Top CVEs (by score)</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="5" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px;">
        “Worst status” is computed as: Unpatched &gt; Ignored &gt; Patched.
      </div>
    </div>
  </section>

  <!-- ===== Sources ===== -->
  <section class="page" id="page-sources">
    <div class="panel">
      <h3 class="panel-title">Sources</h3>
      <div class="muted">
        Displays reference links found in Yocto issues (if present in <code>issue.link</code>).
      </div>

      <div style="height:12px"></div>

      <div class="tableWrap">
        <table class="tableTight">
          <thead>
            <tr>
              <th style="width:180px">CVE</th>
              <th style="width:240px">Package</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody id="sourcesBody">
            <tr><td colspan="3" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== Packages ===== -->
  <section class="page" id="page-packages">
    <div class="panel">
      <h3 class="panel-title">Packages</h3>
      <div class="muted">Click a package to drill down. Shows counts by severity derived from CVSS. (Local-only)</div>
      <div style="height:12px"></div>

      <div class="controls">
        <input id="pkgSearch" type="text" placeholder="Search package name / layer..." />
        <select id="pkgLayerFilter">
          <option value="">All layers</option>
        </select>
      </div>

      <div class="pkgList" id="pkgList"></div>
    </div>

    <div style="height:14px"></div>

    <div class="panel" id="pkgDetailPanel">
      <h3 class="panel-title">Package Details</h3>
      <div class="muted">Select a package to see its issues.</div>
    </div>
  </section>

  <!-- ===== Issues ===== -->
  <section class="page" id="page-issues">
    <div class="panel">
      <h3 class="panel-title">Issues</h3>

      <div class="controls">
        <input id="q" type="text" placeholder="Search CVE / package / summary..." />
        <select id="sevFilter">
          <option value="">All severities</option>
          <option>Critical</option><option>High</option><option>Medium</option><option>Low</option><option>None</option>
        </select>
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option>Patched</option><option>Unpatched</option><option>Ignored</option>
        </select>
        <button class="btn" id="csvBtn">Export filtered CSV</button>
      </div>

      <div class="tableWrap">
        <table class="tableTight">
          <thead>
            <tr>
              <th style="width:180px">CVE</th>
              <th style="width:140px">Severity</th>
              <th style="width:260px">Package</th>
              <th style="width:140px">Version</th>
              <th style="width:140px">Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted tipLine">
        Tip: Click any row to open the full CVE view.
      </div>
    </div>
  </section>

  <!-- ===== FULL-PAGE CVE VIEW (GTI-like) ===== -->
  <section class="page" id="page-cve">
    <div class="cveTopbar">
      <button class="btn btnGhost" id="cveBackBtn">← Back</button>

      <div class="cveHead">
        <div class="cveTitleRow">
          <div class="cveId" id="cveId">CVE-—</div>
          <span id="cveSevPill"></span>
          <span class="chip" id="cveStatusChip"><strong>Status</strong>: —</span>
        </div>
        <div class="cveMeta muted" id="cveMeta">
          Published: — • Modified: — • EPSS: —
        </div>
      </div>

      <div class="cveActions">
        <a class="btn btnGhost" id="cveNvdBtn" href="#" target="_blank" rel="noopener">Open in NVD</a>
        <button class="btn" id="cveRefreshBtn">Refresh intel</button>
      </div>
    </div>

    <div class="grid2 cveGrid">
      <div class="panel">
        <h3 class="panel-title">Executive Summary</h3>
        <div class="muted" id="cveExec">—</div>
      </div>

      <div class="panel">
        <h3 class="panel-title">Risk snapshot</h3>
        <div class="riskGrid">
          <div class="riskCard">
            <div class="k">CVSS Base (v3.1/v3)</div>
            <div class="v" id="cveCvss3">—</div>
            <div class="muted" id="cveCvss3Vec">—</div>
          </div>
          <div class="riskCard">
            <div class="k">CVSS Base (v2)</div>
            <div class="v" id="cveCvss2">—</div>
            <div class="muted" id="cveCvss2Vec">—</div>
          </div>
          <div class="riskCard">
            <div class="k">Exploitability</div>
            <div class="v" id="cveExploit">—</div>
            <div class="muted" id="cveExploitNote">—</div>
          </div>
          <div class="riskCard">
            <div class="k">Impact</div>
            <div class="v" id="cveImpact">—</div>
            <div class="muted" id="cveImpactNote">—</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3 class="panel-title">Description (NVD)</h3>
        <div class="muted" id="cveDesc">—</div>
        <div class="muted smallNote" id="cveIntelNote"></div>
      </div>

      <div class="panel">
        <h3 class="panel-title">EPSS (FIRST)</h3>
        <div class="epssGrid">
          <div class="epssCard">
            <div class="k">Probability</div>
            <div class="v" id="cveEpssProb">—</div>
            <div class="muted">Likelihood of exploitation in next 30 days</div>
          </div>
          <div class="epssCard">
            <div class="k">Percentile</div>
            <div class="v" id="cveEpssPct">—</div>
            <div class="muted">Compared to other CVEs</div>
          </div>
        </div>
      </div>

      <div class="panel cveWide">
        <h3 class="panel-title">Affected in this build (Yocto)</h3>
        <div class="tableWrap">
          <table class="tableTight">
            <thead>
              <tr>
                <th style="width:260px">Package</th>
                <th style="width:140px">Version</th>
                <th style="width:220px">Layer</th>
                <th style="width:140px">Status</th>
                <th style="width:140px">Severity</th>
              </tr>
            </thead>
            <tbody id="cveAffectedBody"></tbody>
          </table>
        </div>
      </div>

      <div class="panel cveWide">
        <h3 class="panel-title">Developer tips</h3>
        <ul class="muted tips" id="cveTips"></ul>
      </div>
    </div>
  </section>

</main>

<script>
  // ===== Utilities =====
  const $ = (id)=>document.getElementById(id);
  const nowISO = ()=> new Date().toISOString();

  function esc(s){ return String(s ?? "").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
  function toNum(x){
    const n = Number(String(x ?? "").trim());
    return Number.isFinite(n) ? n : 0;
  }

  function severityFrom(issue){
    const v3 = toNum(issue.scorev3);
    const v2 = toNum(issue.scorev2);
    const s = v3 > 0 ? v3 : v2;
    if (s >= 9.0) return "Critical";
    if (s >= 7.0) return "High";
    if (s >= 4.0) return "Medium";
    if (s >  0.0) return "Low";
    return "None";
  }

  function sevColor(sev){
    switch(sev){
      case "Critical": return "rgba(255, 88, 120, 0.95)";
      case "High":     return "rgba(255, 170, 80, 0.95)";
      case "Medium":   return "rgba(120, 200, 255, 0.95)";
      case "Low":      return "rgba(140, 255, 180, 0.95)";
      default:         return "rgba(200, 200, 200, 0.85)";
    }
  }

  function sevBadge(sev){
    return `<span class="sevBadge"><span class="dot" style="background:${sevColor(sev)}"></span>${esc(sev)}</span>`;
  }

  function cvssClass(score){
    const s = toNum(score);
    if (s >= 9.0) return "cvss crit";
    if (s >= 7.0) return "cvss high";
    if (s >= 4.0) return "cvss med";
    if (s >  0.0) return "cvss low";
    return "cvss none";
  }
  function cvssLabel(score){
    const s = toNum(score);
    if (!s) return "NONE";
    if (s >= 9.0) return "CRITICAL";
    if (s >= 7.0) return "HIGH";
    if (s >= 4.0) return "MEDIUM";
    return "LOW";
  }
  function cvssPill(score){
    const s = toNum(score);
    if (!s) return `<span class="${cvssClass(0)}">—</span>`;
    return `<span class="${cvssClass(s)}">${s.toFixed(1)} <span class="cvssTxt">(${cvssLabel(s)})</span></span>`;
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // ===== Developer tips =====
  function developerTipsFor(r){
    const tips = [];
    tips.push("Verify the vulnerable component is actually shipped in the final image and reachable (runtime path, service exposure, feature enabled).");

    if (r.status === "Patched") {
      tips.push("Already marked Patched in Yocto CVE report. Confirm the patch/version is present in your build output and deployed image.");
      tips.push("If devices are deployed, schedule rollout/OTA so patched binaries land on targets.");
    } else if (r.status === "Unpatched") {
      tips.push("Preferred: upgrade the recipe/package to a version that includes the fix.");
      tips.push("If upgrade is risky, backport the upstream patch using a .bbappend (keep attribution; rebuild and retest).");
      tips.push("After applying fix: rebuild + re-run `bitbake <image> -c cve_check` to confirm it becomes Patched.");
    } else if (r.status === "Ignored") {
      tips.push("Ignored requires justification (not affected, mitigated, feature disabled, unreachable). Document this and get security sign-off.");
      tips.push("Re-check ignored CVEs when upgrading layers or enabling new features.");
    } else {
      tips.push("Review the CVE reference and assess whether your build configuration is affected.");
    }

    tips.push(`Yocto workflow: identify the recipe providing "${r.pkg}" (layer: ${r.layer || "unknown"}) and check version "${r.pkgVersion || "unknown"}".`);
    tips.push("If the vulnerable code is a dependency, check which recipe pulls it in and whether it can be updated or configured out.");
    tips.push("Validate fixes using SBOM + runtime scan (Syft/Grype) to ensure the deployed rootfs matches expectations.");
    tips.push("Prioritize network-facing Critical/High issues first; consider exposure and mitigations even when patching is delayed.");

    return tips;
  }

  // ===== State =====
  let yocto = null;             // raw JSON
  let rows = [];                // flattened issues
  let pkgIndex = [];            // per-package aggregates
  let filtered = [];
  let sevChart = null;
  let pkgChart = null;

  let currentCve = null;
  let currentCveIntel = { nvd: null, epss: null };

  // ===== Charts (crisp) =====
  function buildSevChart(counts){
    const labels = ["Critical","High","Medium","Low","None"];
    const data = labels.map(l=>counts[l] ?? 0);
    if (sevChart) sevChart.destroy();

    sevChart = new Chart($("sevChart"), {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: labels.map(sevColor),
          borderColor: "rgba(255,255,255,.18)",
          borderWidth: 1,
          hoverOffset: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        devicePixelRatio: window.devicePixelRatio || 1,
        cutout: "62%",
        rotation: -90,
        circumference: 360,
        plugins: {
          legend: { position: "top", labels: { color: "rgba(234,240,255,.85)", boxWidth: 14 } }
        }
      }
    });
  }

  function buildPkgChart(pkgCounts){
    const pairs = Object.entries(pkgCounts).sort((a,b)=>b[1]-a[1]).slice(0, 12);
    const labels = pairs.map(p=>p[0]);
    const data = pairs.map(p=>p[1]);
    if (pkgChart) pkgChart.destroy();

    pkgChart = new Chart($("pkgChart"), {
      type: "bar",
      data: { labels, datasets: [{ data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        devicePixelRatio: window.devicePixelRatio || 1,
        plugins: { legend: { display:false } },
        scales: {
          x: { ticks: { color:"rgba(234,240,255,.75)" }, grid: { color:"rgba(255,255,255,.06)" } },
          y: { ticks: { color:"rgba(234,240,255,.75)" }, grid: { color:"rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  // ===== Tabs + Hash support =====
  function setTab(name, pushHash = true){
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.page===name));
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    const page = document.getElementById(`page-${name}`);
    if (page) page.classList.add("active");

    if (!pushHash) return;

    // If CVE view, we store hash as #cve=CVE-XXXX-YYYY
    if (name === "cve" && currentCve){
      const newHash = `#cve=${encodeURIComponent(currentCve)}`;
      if (location.hash !== newHash) history.pushState({tab:"cve", cve: currentCve}, "", newHash);
      return;
    }

    const newHash = `#${name}`;
    if (location.hash !== newHash) history.pushState({tab:name}, "", newHash);
  }

  function parseHash(){
    const h = (location.hash || "#summary").replace("#","");
    if (h.startsWith("cve=")){
      return { tab: "cve", cve: decodeURIComponent(h.slice(4)) };
    }
    return { tab: h, cve: null };
  }

  function applyHashTab(){
    const { tab, cve } = parseHash();
    const allowed = new Set(["summary","products","sources","packages","issues","cve"]);
    const safeTab = allowed.has(tab) ? tab : "summary";
    setTab(safeTab, false);

    if (safeTab === "cve" && cve){
      // open CVE view from hash
      openCveView(cve, { pushHash: false, tryFetch: true });
    }
  }
  window.addEventListener("popstate", applyHashTab);
  window.addEventListener("hashchange", applyHashTab);

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>setTab(t.dataset.page, true));
  });

  // ===== GTI-style renderers =====
  function renderProductsAndFixes(){
    if (!pkgIndex.length){
      $("productsBody").innerHTML = `<tr><td colspan="5" class="muted">No data loaded.</td></tr>`;
      return;
    }

    const byPkg = new Map();
    for (const r of rows){
      const arr = byPkg.get(r.pkg) || [];
      arr.push(r);
      byPkg.set(r.pkg, arr);
    }

    const sevRank = (p)=> (p.sevCounts.Critical*100000 + p.sevCounts.High*10000 + p.sevCounts.Medium*1000 + p.total);
    const list = [...pkgIndex].sort((a,b)=>sevRank(b)-sevRank(a));

    $("productsBody").innerHTML = list.map(p=>{
      const issues = (byPkg.get(p.name) || [])
        .sort((a,b)=>{
          const sa = Math.max(toNum(a.scorev3), toNum(a.scorev2));
          const sb = Math.max(toNum(b.scorev3), toNum(b.scorev2));
          return sb - sa;
        })
        .slice(0, 5)
        .map(x=>x.cve)
        .join(", ");

      const worstStatus =
        p.unpatched ? "Unpatched" :
        p.ignored   ? "Ignored"   :
        p.patched   ? "Patched"   : "—";

      return `
        <tr>
          <td><strong>${esc(p.name)}</strong></td>
          <td>${esc(p.version || "—")}</td>
          <td>${esc(p.layer || "—")}</td>
          <td>${esc(worstStatus)}</td>
          <td class="muted">${esc(issues || "—")}</td>
        </tr>
      `;
    }).join("");
  }

  function renderSources(){
    const list = rows.filter(r=>r.link);
    if (!list.length){
      $("sourcesBody").innerHTML = `<tr><td colspan="3" class="muted">No references present in this Yocto JSON.</td></tr>`;
      return;
    }
    $("sourcesBody").innerHTML = list.slice(0, 800).map(r=>`
      <tr>
        <td><strong class="linkLike" data-cve="${esc(r.cve)}">${esc(r.cve)}</strong></td>
        <td>${esc(r.pkg)}</td>
        <td><a class="link" href="${esc(r.link)}" target="_blank" rel="noopener">Open link</a></td>
      </tr>
    `).join("");

    // Clicking CVE in Sources opens CVE view
    $("sourcesBody").querySelectorAll(".linkLike").forEach(el=>{
      el.addEventListener("click", ()=>{
        const cve = el.getAttribute("data-cve");
        openCveView(cve, { pushHash: true, tryFetch: true });
      });
    });
  }

  // ===== CVE VIEW (full page) =====
  function bestYoctoRowForCve(cve){
    const list = rows.filter(r=>r.cve === cve);
    if (!list.length) return null;
    const rank = (sev)=> ({Critical:4,High:3,Medium:2,Low:1,None:0}[sev] ?? 0);
    return [...list].sort((a,b)=>{
      const ra = rank(a.sev), rb = rank(b.sev);
      if (rb !== ra) return rb - ra;
      const sa = Math.max(toNum(a.scorev3), toNum(a.scorev2));
      const sb = Math.max(toNum(b.scorev3), toNum(b.scorev2));
      return sb - sa;
    })[0];
  }

  function renderCveAffected(cve){
    const list = rows.filter(r=>r.cve === cve);
    if (!list.length){
      $("cveAffectedBody").innerHTML = `<tr><td colspan="5" class="muted">This CVE was not found in the currently loaded Yocto JSON.</td></tr>`;
      return;
    }
    $("cveAffectedBody").innerHTML = list.map(r=>`
      <tr>
        <td><strong>${esc(r.pkg)}</strong></td>
        <td>${esc(r.pkgVersion || "—")}</td>
        <td>${esc(r.layer || "—")}</td>
        <td>${esc(r.status || "—")}</td>
        <td>${sevBadge(r.sev)}</td>
      </tr>
    `).join("");
  }

  function renderCveTips(cve){
    const r = bestYoctoRowForCve(cve);
    const tips = r ? developerTipsFor(r) : ["Load Yocto JSON to see build-specific tips for this CVE."];
    $("cveTips").innerHTML = tips.map(t=>`<li>${esc(t)}</li>`).join("");
  }

  function renderCveHeaderFromYocto(cve){
    const r = bestYoctoRowForCve(cve);

    $("cveId").textContent = cve;
    $("cveStatusChip").innerHTML = `<strong>Status</strong>: ${esc(r?.status || "—")}`;
    $("cveSevPill").innerHTML = r ? sevBadge(r.sev) : sevBadge("None");

    // Executive summary defaults to Yocto summary
    $("cveExec").textContent = r?.summary ? r.summary : "No Yocto summary available for this CVE in the loaded JSON.";
    $("cveNvdBtn").href = `https://nvd.nist.gov/vuln/detail/${encodeURIComponent(cve)}`;

    // Placeholders until intel is fetched
    $("cveMeta").textContent = `Published: — • Modified: — • EPSS: —`;
    $("cveDesc").textContent = "—";
    $("cveIntelNote").textContent = "";

    // CVSS pills (prefer yocto score display right away)
    const s3 = toNum(r?.scorev3);
    const s2 = toNum(r?.scorev2);
    $("cveCvss3").innerHTML = s3 ? cvssPill(s3) : `<span class="cvss none">—</span>`;
    $("cveCvss2").innerHTML = s2 ? cvssPill(s2) : `<span class="cvss none">—</span>`;
    $("cveCvss3Vec").textContent = r?.vector ? r.vector : "—";
    $("cveCvss2Vec").textContent = r?.vector ? r.vector : "—";

    $("cveExploit").textContent = "—";
    $("cveExploitNote").textContent = "From NVD if available";
    $("cveImpact").textContent = "—";
    $("cveImpactNote").textContent = "From NVD if available";

    $("cveEpssProb").textContent = "—";
    $("cveEpssPct").textContent = "—";

    renderCveAffected(cve);
    renderCveTips(cve);
  }

  function pickNvdMetric(nvd){
    // NVD v2.0: metrics may have cvssMetricV31, cvssMetricV30, cvssMetricV2, etc.
    const m = nvd?.vulnerabilities?.[0]?.cve?.metrics || {};
    const v31 = m.cvssMetricV31?.[0];
    const v30 = m.cvssMetricV30?.[0];
    const v2  = m.cvssMetricV2?.[0];
    return { v31, v30, v2 };
  }

  function pickNvdDesc(nvd){
    const d = nvd?.vulnerabilities?.[0]?.cve?.descriptions || [];
    return d.find(x=>x.lang==="en")?.value || d[0]?.value || "";
  }

  async function fetchNvd(cve){
    // NVD API (may rate-limit; CORS usually OK but depends)
    const url = `https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${encodeURIComponent(cve)}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`NVD fetch failed (${res.status})`);
    return await res.json();
  }

  async function fetchEpss(cve){
    const url = `https://api.first.org/data/v1/epss?cve=${encodeURIComponent(cve)}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`EPSS fetch failed (${res.status})`);
    return await res.json();
  }

  function renderCveIntel(cve, nvd, epss){
    // NVD
    if (nvd){
      const pub = nvd?.vulnerabilities?.[0]?.cve?.published || "—";
      const mod = nvd?.vulnerabilities?.[0]?.cve?.lastModified || "—";
      const desc = pickNvdDesc(nvd);

      const { v31, v30, v2 } = pickNvdMetric(nvd);
      const v3m = v31 || v30;
      const v3 = v3m?.cvssData;
      const v2d = v2?.cvssData;

      if (desc) $("cveDesc").textContent = desc;

      // CVSS v3
      if (v3?.baseScore != null){
        $("cveCvss3").innerHTML = cvssPill(v3.baseScore);
        $("cveCvss3Vec").textContent = v3.vectorString || "—";
      }

      // CVSS v2
      if (v2d?.baseScore != null){
        $("cveCvss2").innerHTML = cvssPill(v2d.baseScore);
        $("cveCvss2Vec").textContent = v2d.vectorString || "—";
      }

      // Exploitability / Impact (NVD provides some subscores)
      const exploit = v3m?.exploitabilityScore ?? v2?.exploitabilityScore;
      const impact  = v3m?.impactScore ?? v2?.impactScore;

      $("cveExploit").textContent = exploit != null ? String(exploit) : "—";
      $("cveImpact").textContent  = impact  != null ? String(impact)  : "—";

      // Meta line updated after EPSS too
      const epssText = epss?.data?.[0]?.epss ? `${(Number(epss.data[0].epss)*100).toFixed(2)}%` : "—";
      const pctText  = epss?.data?.[0]?.percentile ? `${(Number(epss.data[0].percentile)*100).toFixed(2)}%` : "—";
      $("cveMeta").textContent = `Published: ${pub} • Modified: ${mod} • EPSS: ${epssText} (pct ${pctText})`;
    }

    // EPSS cards
    if (epss?.data?.[0]){
      const p = Number(epss.data[0].epss);
      const pct = Number(epss.data[0].percentile);
      $("cveEpssProb").textContent = Number.isFinite(p) ? `${(p*100).toFixed(2)}%` : "—";
      $("cveEpssPct").textContent  = Number.isFinite(pct) ? `${(pct*100).toFixed(2)}%` : "—";
    }
  }

  async function loadCveIntel(cve){
    $("cveIntelNote").textContent = "Fetching NVD + EPSS…";
    let nvd = null, epss = null;

    try {
      // parallel fetch
      const [nvdRes, epssRes] = await Promise.allSettled([fetchNvd(cve), fetchEpss(cve)]);
      if (nvdRes.status === "fulfilled") nvd = nvdRes.value;
      if (epssRes.status === "fulfilled") epss = epssRes.value;

      currentCveIntel = { nvd, epss };

      if (!nvd && !epss){
        $("cveIntelNote").textContent =
          "Could not fetch external intel (blocked by network/CORS or rate-limited). Showing Yocto-only data.";
      } else if (!nvd){
        $("cveIntelNote").textContent =
          "NVD data not available right now (rate-limit/CORS). Showing Yocto + EPSS.";
      } else if (!epss){
        $("cveIntelNote").textContent =
          "EPSS not available right now (network/CORS). Showing Yocto + NVD.";
      } else {
        $("cveIntelNote").textContent = "External intel loaded (NVD + EPSS).";
      }

      renderCveIntel(cve, nvd, epss);
    } catch (e){
      $("cveIntelNote").textContent =
        "Could not fetch external intel. Showing Yocto-only data.";
    }
  }

  function openCveView(cve, opts={ pushHash:true, tryFetch:true }){
    currentCve = cve;
    renderCveHeaderFromYocto(cve);
    setTab("cve", opts.pushHash);

    if (opts.tryFetch){
      loadCveIntel(cve);
    }
  }

  $("cveBackBtn").addEventListener("click", ()=>{
    // Prefer browser history back if it returns to previous tab
    if (history.length > 1) history.back();
    else setTab("issues", true);
  });

  $("cveRefreshBtn").addEventListener("click", ()=>{
    if (!currentCve) return;
    loadCveIntel(currentCve);
  });

  // ===== Parsing Yocto cve-summary.json =====
  function buildFromYocto(obj){
    yocto = obj;
    rows = [];
    pkgIndex = [];

    const pkgs = obj.package || [];
    const layerSet = new Set();

    let maxCvss3 = 0, maxCvss2 = 0;
    const vectorCounts = {};

    for (const p of pkgs){
      const pkgName = p.name ?? "unknown";
      const pkgLayer = p.layer ?? "";
      const pkgVer = p.version ?? "";
      layerSet.add(pkgLayer);

      const issues = Array.isArray(p.issue) ? p.issue : [];
      const sevCounts = {Critical:0,High:0,Medium:0,Low:0,None:0};
      let patched = 0, unpatched = 0, ignored = 0;

      for (const iss of issues){
        const sev = severityFrom(iss);
        sevCounts[sev] = (sevCounts[sev]||0)+1;

        const s3 = toNum(iss.scorev3); const s2 = toNum(iss.scorev2);
        if (s3 > maxCvss3) maxCvss3 = s3;
        if (s2 > maxCvss2) maxCvss2 = s2;

        const vec = (iss.vector || "").trim();
        if (vec) vectorCounts[vec] = (vectorCounts[vec]||0)+1;

        const status = iss.status ?? "";
        if (status === "Patched") patched++;
        else if (status === "Unpatched") unpatched++;
        else if (status === "Ignored") ignored++;

        rows.push({
          cve: iss.id ?? "UNKNOWN",
          summary: iss.summary ?? "",
          scorev2: iss.scorev2 ?? "",
          scorev3: iss.scorev3 ?? "",
          vector: iss.vector ?? "",
          status: status,
          link: iss.link ?? "",
          pkg: pkgName,
          pkgVersion: pkgVer,
          layer: pkgLayer,
          sev
        });
      }

      if (issues.length){
        pkgIndex.push({
          name: pkgName,
          version: pkgVer,
          layer: pkgLayer,
          total: issues.length,
          sevCounts,
          patched, unpatched, ignored
        });
      }
    }

    // Header meta
    $("createdLine").textContent = `Report generated: ${nowISO()}`;
    $("pkgLine").textContent = `Packages: ${pkgs.length.toLocaleString()}`;
    $("issueLine").textContent = `Issues: ${rows.length.toLocaleString()}`;

    $("schemaV").textContent = String(obj.version ?? "—");
    $("affPkgs").textContent = new Set(rows.map(r=>r.pkg)).size.toLocaleString();
    $("totalIssues").textContent = rows.length.toLocaleString();
    const open = rows.filter(r => r.status === "Unpatched" || r.status === "Ignored").length;
    $("openIssues").textContent = open.toLocaleString();

    $("maxCvss3").textContent = maxCvss3 ? maxCvss3.toFixed(1) : "—";
    $("maxCvss2").textContent = maxCvss2 ? maxCvss2.toFixed(1) : "—";
    const commonVector = Object.entries(vectorCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "—";
    $("commonVector").textContent = commonVector;

    // Executive summary text
    const patched = rows.filter(r=>r.status==="Patched").length;
    const unpatched = rows.filter(r=>r.status==="Unpatched").length;
    const ignored = rows.filter(r=>r.status==="Ignored").length;
    const uniqCves = new Set(rows.map(r=>r.cve)).size;

    $("execSummary").innerHTML = `
      <div class="muted">
        This is a local report generated from Yocto <code>cve-summary.json</code>. It includes
        <strong>${rows.length.toLocaleString()}</strong> CVE issues across
        <strong>${new Set(rows.map(r=>r.pkg)).size.toLocaleString()}</strong> affected packages
        (<strong>${uniqCves.toLocaleString()}</strong> unique CVE IDs).
        Status breakdown: <strong>${patched}</strong> patched, <strong>${unpatched}</strong> unpatched, <strong>${ignored}</strong> ignored.
      </div>
    `;

    // Chips
    const counts = {Critical:0,High:0,Medium:0,Low:0,None:0};
    const statusCounts = {Patched:0,Unpatched:0,Ignored:0};
    for (const r of rows){
      counts[r.sev] = (counts[r.sev]||0)+1;
      if (r.status in statusCounts) statusCounts[r.status]++;
    }

    const chips = [];
    chips.push(`<span class="chip info"><span class="dot" style="background:var(--info)"></span><strong>Schema</strong>: ${esc(obj.version ?? "—")}</span>`);
    chips.push(`<span class="chip bad"><span class="dot" style="background:${sevColor("Critical")}"></span><strong>Critical</strong>: ${counts.Critical}</span>`);
    chips.push(`<span class="chip warn"><span class="dot" style="background:${sevColor("High")}"></span><strong>High</strong>: ${counts.High}</span>`);
    chips.push(`<span class="chip"><span class="dot" style="background:${sevColor("Medium")}"></span><strong>Medium</strong>: ${counts.Medium}</span>`);
    chips.push(`<span class="chip good"><span class="dot" style="background:${sevColor("Low")}"></span><strong>Low</strong>: ${counts.Low}</span>`);
    chips.push(`<span class="chip good"><span class="dot" style="background:var(--good)"></span><strong>Patched</strong>: ${statusCounts.Patched}</span>`);
    chips.push(`<span class="chip warn"><span class="dot" style="background:var(--warn)"></span><strong>Unpatched</strong>: ${statusCounts.Unpatched}</span>`);
    chips.push(`<span class="chip"><span class="dot" style="background:rgba(200,200,200,.85)"></span><strong>Ignored</strong>: ${statusCounts.Ignored}</span>`);
    $("chipbar").innerHTML = chips.join("");

    // Charts
    buildSevChart(counts);
    const pkgCounts = {};
    for (const r of rows) pkgCounts[r.pkg] = (pkgCounts[r.pkg]||0)+1;
    buildPkgChart(pkgCounts);

    // Top CVEs table (clean summary clamp)
    const top = [...rows].sort((a,b)=>{
      const rank = (sev)=> ({Critical:4,High:3,Medium:2,Low:1,None:0}[sev] ?? 0);
      const ra = rank(a.sev), rb = rank(b.sev);
      if (rb !== ra) return rb - ra;
      const sa = Math.max(toNum(a.scorev3), toNum(a.scorev2));
      const sb = Math.max(toNum(b.scorev3), toNum(b.scorev2));
      return sb - sa;
    }).slice(0, 12);

    $("topCvesBody").innerHTML = top.map(r=>`
      <tr class="rowLink" data-cve="${esc(r.cve)}">
        <td><strong class="linkLike">${esc(r.cve)}</strong></td>
        <td>${sevBadge(r.sev)}</td>
        <td><div class="summaryClamp">${esc(r.summary || "")}</div></td>
        <td>${esc(r.status)}</td>
      </tr>
    `).join("");

    // Direct open CVE view
    $("topCvesBody").querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const cve = tr.getAttribute("data-cve");
        openCveView(cve, { pushHash: true, tryFetch: true });
      });
    });

    // Packages page prep
    const layerList = [...layerSet].filter(Boolean).sort();
    $("pkgLayerFilter").innerHTML =
      `<option value="">All layers</option>` + layerList.map(l=>`<option value="${esc(l)}">${esc(l)}</option>`).join("");
    renderPackagesList();

    // Issues page default
    $("q").value = ""; $("sevFilter").value=""; $("statusFilter").value="";
    filtered = [...rows];
    renderIssuesTable();

    // Fill derived views
    renderProductsAndFixes();
    renderSources();

    // After load, honor hash (maybe #cve=...) or default summary
    applyHashTab();
  }

  // ===== Packages page =====
  function renderPackagesList(){
    const q = $("pkgSearch").value.trim().toLowerCase();
    const layer = $("pkgLayerFilter").value;

    let list = pkgIndex;
    if (layer) list = list.filter(p=>p.layer===layer);
    if (q) list = list.filter(p => (p.name||"").toLowerCase().includes(q) || (p.layer||"").toLowerCase().includes(q));

    const rank = (p)=> (p.sevCounts.Critical*100000 + p.sevCounts.High*10000 + p.total);
    list = [...list].sort((a,b)=>rank(b)-rank(a));

    $("pkgList").innerHTML = list.map(p=>{
      const sc = p.sevCounts;
      return `
        <div class="pkgCard" data-name="${esc(p.name)}">
          <div class="pkgTop">
            <div style="min-width:0;">
              <div class="pkgName">${esc(p.name)}</div>
              <div class="pkgMeta">version: ${esc(p.version || "—")} • layer: ${esc(p.layer || "—")} • issues: <strong>${p.total}</strong></div>
            </div>
            <div>${sevBadge(sc.Critical? "Critical": sc.High? "High": sc.Medium? "Medium": sc.Low? "Low":"None")}</div>
          </div>
          <div class="miniRow">
            <span class="miniPill" style="border-color:rgba(255,88,120,.35);color:#fecaca;">Critical: ${sc.Critical}</span>
            <span class="miniPill" style="border-color:rgba(255,170,80,.35);color:#fde68a;">High: ${sc.High}</span>
            <span class="miniPill" style="border-color:rgba(120,200,255,.35);color:#bfdbfe;">Medium: ${sc.Medium}</span>
            <span class="miniPill" style="border-color:rgba(140,255,180,.35);color:#bbf7d0;">Low: ${sc.Low}</span>
            <span class="miniPill">Patched: ${p.patched}</span>
            <span class="miniPill">Unpatched: ${p.unpatched}</span>
            <span class="miniPill">Ignored: ${p.ignored}</span>
          </div>
        </div>
      `;
    }).join("");

    document.querySelectorAll(".pkgCard").forEach(card=>{
      card.addEventListener("click", ()=>{
        const name = card.getAttribute("data-name");
        renderPackageDetails(name);
      });
    });
  }

  function renderPackageDetails(pkgName){
    const issues = rows.filter(r=>r.pkg===pkgName);
    if (!issues.length){
      $("pkgDetailPanel").innerHTML = `<h3 class="panel-title">Package Details</h3><div class="muted">No issues found.</div>`;
      return;
    }
    const pkgMeta = pkgIndex.find(p=>p.name===pkgName);
    const top = [...issues].sort((a,b)=>{
      const rank = (sev)=> ({Critical:4,High:3,Medium:2,Low:1,None:0}[sev] ?? 0);
      const ra = rank(a.sev), rb = rank(b.sev);
      if (rb !== ra) return rb - ra;
      const sa = Math.max(toNum(a.scorev3), toNum(a.scorev2));
      const sb = Math.max(toNum(b.scorev3), toNum(b.scorev2));
      return sb - sa;
    });

    $("pkgDetailPanel").innerHTML = `
      <h3 class="panel-title">Package Details</h3>
      <div class="muted"><strong>${esc(pkgName)}</strong> • version: ${esc(pkgMeta?.version || "—")} • layer: ${esc(pkgMeta?.layer || "—")} • issues: ${issues.length}</div>
      <div style="height:12px"></div>
      <div class="tableWrap">
        <table class="tableTight">
          <thead>
            <tr>
              <th style="width:180px">CVE</th>
              <th style="width:140px">Severity</th>
              <th>Summary</th>
              <th style="width:140px">Status</th>
              <th style="width:140px">CVSS</th>
            </tr>
          </thead>
          <tbody>
            ${top.slice(0, 50).map(r=>{
              const score = Math.max(toNum(r.scorev3), toNum(r.scorev2));
              return `
                <tr class="rowLink" data-cve="${esc(r.cve)}">
                  <td><strong class="linkLike">${esc(r.cve)}</strong></td>
                  <td>${sevBadge(r.sev)}</td>
                  <td><div class="summaryClamp">${esc(r.summary || "")}</div></td>
                  <td>${esc(r.status)}</td>
                  <td>${score ? cvssPill(score) : `<span class="cvss none">—</span>`}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:10px;">Showing up to 50 issues. Click a CVE to open the full CVE view.</div>
    `;

    $("pkgDetailPanel").querySelectorAll("tr[data-cve]").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const cve = tr.getAttribute("data-cve");
        openCveView(cve, { pushHash: true, tryFetch: true });
      });
    });
  }

  // ===== Issues page =====
  function applyIssueFilters(){
    const q = $("q").value.trim().toLowerCase();
    const sevF = $("sevFilter").value;
    const stF  = $("statusFilter").value;

    filtered = rows.filter(r=>{
      if (sevF && r.sev !== sevF) return false;
      if (stF && r.status !== stF) return false;
      if (!q) return true;
      return (
        r.cve.toLowerCase().includes(q) ||
        r.pkg.toLowerCase().includes(q) ||
        (r.summary||"").toLowerCase().includes(q)
      );
    });

    renderIssuesTable();
  }

  function renderIssuesTable(){
    $("tbody").innerHTML = filtered.map(r=>`
      <tr class="rowLink" data-cve="${esc(r.cve)}">
        <td><strong class="linkLike">${esc(r.cve)}</strong></td>
        <td>${sevBadge(r.sev)}</td>
        <td>${esc(r.pkg)}</td>
        <td>${esc(r.pkgVersion || "")}</td>
        <td>${esc(r.status || "")}</td>
      </tr>
    `).join("");

    // Direct open CVE view from Issues tab (no extra step)
    $("tbody").querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const cve = tr.getAttribute("data-cve");
        openCveView(cve, { pushHash: true, tryFetch: true });
      });
    });
  }

  // ===== Events =====
  $("file").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const text = await f.text();
    const obj = JSON.parse(text);

    if (!obj || !Array.isArray(obj.package)){
      alert("This doesn't look like Yocto cve-summary.json (expected top-level { package: [...] }).");
      return;
    }
    buildFromYocto(obj);
  });

  $("resetBtn").addEventListener("click", ()=>{
    yocto=null; rows=[]; pkgIndex=[]; filtered=[];
    currentCve = null; currentCveIntel = { nvd:null, epss:null };

    $("reportTitle").textContent = "VulnTrack Report";
    $("createdLine").textContent = "Report generated: —";
    $("pkgLine").textContent = "Packages: —";
    $("issueLine").textContent = "Issues: —";
    $("chipbar").innerHTML = `<span class="chip">Load <strong>cve-summary.json</strong> to view</span>`;
    $("schemaV").textContent = $("affPkgs").textContent = $("totalIssues").textContent = $("openIssues").textContent = "—";
    $("maxCvss3").textContent = $("maxCvss2").textContent = $("commonVector").textContent = "—";
    $("topCvesBody").innerHTML = "";
    $("pkgList").innerHTML = "";
    $("pkgDetailPanel").innerHTML = `<h3 class="panel-title">Package Details</h3><div class="muted">Select a package to see its issues.</div>`;
    $("tbody").innerHTML = "";
    $("q").value=""; $("sevFilter").value=""; $("statusFilter").value="";
    $("pkgSearch").value=""; $("pkgLayerFilter").innerHTML = `<option value="">All layers</option>`;

    $("productsBody").innerHTML = `<tr><td colspan="5" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>`;
    $("sourcesBody").innerHTML  = `<tr><td colspan="3" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>`;

    if (sevChart) sevChart.destroy();
    if (pkgChart) pkgChart.destroy();
    sevChart = pkgChart = null;

    // reset hash
    history.pushState({tab:"summary"}, "", "#summary");
    setTab("summary", false);
    $("file").value="";
  });

  ["q","sevFilter","statusFilter"].forEach(id=>{
    $(id).addEventListener("input", applyIssueFilters);
    $(id).addEventListener("change", applyIssueFilters);
  });

  $("csvBtn").addEventListener("click", ()=>{
    if (!filtered.length){ alert("No rows to export."); return; }
    const header = ["cve","severity","package","package_version","layer","status","scorev3","scorev2","vector","link","summary"];
    const lines = [header.join(",")];
    for (const r of filtered){
      const row = [
        r.cve, r.sev, r.pkg, r.pkgVersion, r.layer, r.status, r.scorev3, r.scorev2, r.vector, r.link, r.summary
      ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`);
      lines.push(row.join(","));
    }
    downloadText("yocto-filtered-cves.csv", lines.join("\n"));
  });

  $("pkgSearch").addEventListener("input", renderPackagesList);
  $("pkgLayerFilter").addEventListener("change", renderPackagesList);

  // Initialize tab state on first load
  if (!location.hash) history.replaceState({tab:"summary"}, "", "#summary");
  applyHashTab();
</script>

</body>
</html>

