<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VulnTrack Report</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- Minimal CVSS color helpers (kept here to avoid forcing style.css edits) -->
  <style>
    .scorePill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      font-weight:900; font-size:12px;
    }
    .scorePill small{opacity:.85; font-weight:800}
    .score-none{background: rgba(148,163,184,.16); border-color: rgba(148,163,184,.35)}
    .score-low{background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.35)}
    .score-med{background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.35)}
    .score-high{background: rgba(249,115,22,.16); border-color: rgba(249,115,22,.35)}
    .score-crit{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.40)}
    .backRow{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  </style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="h-left">
      <div class="h-title">
        <span class="appTitle" id="reportTitle">VulnTrack Report</span>
        <div class="compatibility-badges">
          <span class="badge">
            <img src="https://www.yoctoproject.org/wp-content/uploads/sites/32/2023/09/YoctoProject_Logo_RGB_White_small.svg" alt="Yocto Logo" height="30">
            Compatible
            </span>
        </div>
      </div>
      <div class="h-sub">
        <span id="createdLine">Report generated: —</span>
        <span id="pkgLine">Packages: —</span>
        <span id="issueLine">Issues: —</span>
      </div>
    </div>

    <div class="actions">
      <label class="btn" for="file">Choose JSON</label>
      <input id="file" type="file" accept=".json,application/json"/>
      <button class="btn" id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="chipbar" id="chipbar">
    <span class="chip">Load <strong>cve-summary.json</strong> to view</span>
  </div>

  <div class="tabs">
    <div class="tab active" data-page="summary">Summary</div>
    <div class="tab" data-page="packages">Packages</div>
    <div class="tab" data-page="issues">Issues</div>
    <div class="tab" data-page="sources">Sources</div>
    <div class="tab" data-page="products">Products & Fixes</div>
    <div class="tab" data-page="sbom">SBOM</div>
  </div>
</header>

<main>

  <!-- ===== Summary ===== -->
  <section class="page active" id="page-summary">
    <div class="grid2">
      <div class="panel">
        <h3 class="panel-title">Summary & Analysis</h3>
        <div class="muted" id="execSummary">
          Load a Yocto <code>cve-summary.json</code> (local). This report summarizes package vulnerabilities found during your build.
        </div>

        <div style="height:12px"></div>

        <h3 class="panel-title">Details</h3>
        <div class="kvgrid">
          <div class="kv"><div class="k">Build schema version</div><div class="v" id="schemaV">—</div></div>
          <div class="kv"><div class="k">Affected packages</div><div class="v" id="affPkgs">—</div></div>
          <div class="kv"><div class="k">Total CVE issues</div><div class="v" id="totalIssues">—</div></div>
          <div class="kv"><div class="k">Unpatched / Ignored</div><div class="v" id="openIssues">—</div></div>
        </div>

        <div style="height:14px"></div>

        <h3 class="panel-title">Top CVEs (by severity)</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:140px">CVE</th>
                <th style="width:120px">Severity</th>
                <th>Summary</th>
                <th style="width:110px">Status</th>
              </tr>
            </thead>
            <tbody id="topCvesBody"></tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:10px;">
          Tip: Click any CVE to open the detailed CVE view (Yocto + NVD + EPSS).
        </div>
      </div>

      <div class="panel">
        <h3 class="panel-title">Priority Visualization</h3>
        <div class="chartWrap"><canvas id="sevChart"></canvas></div>

        <div style="height:14px"></div>

        <h3 class="panel-title">Vulnerable Packages</h3>
        <div class="chartWrap"><canvas id="pkgChart"></canvas></div>

        <div style="height:14px"></div>

        <h3 class="panel-title">CVSS Snapshot</h3>
        <div class="kvgrid">
          <div class="kv"><div class="k">Highest CVSS v3</div><div class="v" id="maxCvss3">—</div></div>
          <div class="kv"><div class="k">Highest CVSS v2</div><div class="v" id="maxCvss2">—</div></div>
          <div class="kv"><div class="k">Most common vector</div><div class="v" id="commonVector">—</div></div>
          <div class="kv"><div class="k">Notes</div><div class="v" style="font-weight:700;color:var(--muted)">Yocto JSON does not include EPSS/KEV/exploit info by default.</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Packages ===== -->
  <section class="page" id="page-packages">
    <div class="panel">
      <h3 class="panel-title">Packages</h3>
      <div class="muted">Click a package to drill down. Shows counts by severity derived from CVSS. (Local-only)</div>
      <div style="height:12px"></div>

      <div class="controls">
        <input id="pkgSearch" type="text" placeholder="Search package name / layer..." />
        <select id="pkgLayerFilter">
          <option value="">All layers</option>
        </select>
      </div>

      <div class="pkgList" id="pkgList"></div>
    </div>

    <div style="height:14px"></div>

    <div class="panel" id="pkgDetailPanel">
      <h3 class="panel-title">Package Details</h3>
      <div class="muted">Select a package to see its issues.</div>
    </div>
  </section>

  <!-- ===== Issues ===== -->
  <section class="page" id="page-issues">
    <div class="panel">
      <h3 class="panel-title">Issues</h3>

      <div class="controls">
        <input id="q" type="text" placeholder="Search CVE / package / summary..." />
        <select id="sevFilter">
          <option value="">All severities</option>
          <option>Critical</option><option>High</option><option>Medium</option><option>Low</option><option>None</option>
        </select>
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option>Patched</option><option>Unpatched</option><option>Ignored</option>
        </select>
        <button class="btn" id="csvBtn">Export filtered CSV</button>
      </div>

      <div class="grid2" style="grid-template-columns: 1.3fr .7fr;">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:140px">CVE</th>
                <th style="width:120px">Severity</th>
                <th style="width:220px">Package</th>
                <th style="width:110px">Version</th>
                <th style="width:110px">Status</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="panel" id="detailsPanel">
          <h3 class="panel-title">Issue Details</h3>
          <div class="muted">Click an issue row to view details.</div>
          <div class="muted" style="margin-top:10px;">Tip: Click any row to open the full CVE view.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Sources ===== -->
  <section class="page" id="page-sources">
    <div class="panel">
      <h3 class="panel-title">Sources</h3>
      <div class="muted">
        Displays reference links found in Yocto issues (if present in <code>issue.link</code>).
      </div>

      <div style="height:12px"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:160px">CVE</th>
              <th style="width:240px">Package</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody id="sourcesBody">
            <tr><td colspan="3" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== Products & Fixes ===== -->
  <section class="page" id="page-products">
    <div class="panel">
      <h3 class="panel-title">Products & Fixes</h3>
      <div class="muted">
        Derived locally from Yocto package name/version/layer + issue status (Patched / Unpatched / Ignored).
      </div>

      <div style="height:12px"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:220px">Package</th>
              <th style="width:120px">Version</th>
              <th style="width:220px">Layer</th>
              <th style="width:120px">Worst status</th>
              <th>Top CVEs (by score)</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="5" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px;">
        “Worst status” is computed as: Unpatched &gt; Ignored &gt; Patched.
      </div>
    </div>
  </section>

  <!-- ===== SBOM ===== -->
  <section class="page" id="page-sbom">
    <div class="panel">
      <div class="backRow">
        <div>
          <h3 class="panel-title">SBOM</h3>
          <div class="muted">
            Load <strong>CycloneDX JSON</strong> or <strong>SPDX JSON</strong>. Everything stays local in your browser.
          </div>
        </div>
        <div class="actions">
          <label class="btn" for="sbomFile">Choose SBOM</label>
          <input id="sbomFile" type="file" accept=".json,application/json"/>
          <button class="btn" id="sbomClearBtn">Clear SBOM</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="kvgrid">
        <div class="kv"><div class="k">Format</div><div class="v" id="sbomFormat">—</div></div>
        <div class="kv"><div class="k">Components</div><div class="v" id="sbomCompCount">—</div></div>
        <div class="kv"><div class="k">Dependency edges</div><div class="v" id="sbomDepCount">—</div></div>
        <div class="kv"><div class="k">Top licenses</div><div class="v" id="sbomTopLic">—</div></div>
      </div>

      <div style="height:14px"></div>

      <div class="controls">
        <input id="sbomQ" type="text" placeholder="Search name / purl / version / supplier / license..." />
        <select id="sbomLicFilter">
          <option value="">All licenses</option>
        </select>
      </div>

      <div class="grid2" style="grid-template-columns: 1.3fr .7fr;">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:280px">Component</th>
                <th style="width:140px">Version</th>
                <th>License</th>
              </tr>
            </thead>
            <tbody id="sbomTbody">
              <tr><td colspan="3" class="muted">Load an SBOM JSON to populate this view.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="panel" id="sbomDetailsPanel">
          <h3 class="panel-title">Component Details</h3>
          <div class="muted">Click a component row to view details and dependencies.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Full-page CVE view ===== -->
  <section class="page" id="page-cve">
    <div class="panel">
      <div class="backRow">
        <button class="btn" id="cveBackBtn">← Back</button>

        <div class="actions">
          <a class="btn" id="cveNvdBtn" href="#" target="_blank" rel="noopener">Open in NVD</a>
          <button class="btn" id="cveRefreshBtn">Refresh intel</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <div style="font-weight:1000;font-size:20px;" id="cveTitle">CVE-—</div>
        <span class="chip"><strong>Status</strong>: <span id="cveYoctoStatus">—</span></span>
        <span id="cveCvssPill" class="scorePill score-none">—</span>
      </div>

      <div class="muted" style="margin-top:8px;">
        <span id="cveMetaLine">Published: — • Modified: — • EPSS: —</span>
      </div>

      <div style="height:16px"></div>

      <div class="grid2">
        <div class="panel" style="padding:14px;">
          <h3 class="panel-title">Executive Summary</h3>
          <div class="muted" id="cveSummary">—</div>

          <div style="height:14px"></div>

          <h3 class="panel-title">Description (NVD)</h3>
          <div class="muted" id="cveDescription">—</div>

          <div style="height:14px"></div>

          <h3 class="panel-title">References</h3>
          <div class="muted" id="cveRefs">—</div>
        </div>

        <div class="panel" style="padding:14px;">
          <h3 class="panel-title">Risk snapshot</h3>
          <div class="kvgrid">
            <div class="kv"><div class="k">CVSS Base (v3.x)</div><div class="v" id="cveCvss3">—</div></div>
            <div class="kv"><div class="k">Vector</div><div class="v mono" id="cveVector3">—</div></div>
            <div class="kv"><div class="k">CVSS Base (v2)</div><div class="v" id="cveCvss2">—</div></div>
            <div class="kv"><div class="k">EPSS (30d)</div><div class="v" id="cveEpss">—</div></div>
          </div>

          <div style="height:14px"></div>

          <h3 class="panel-title">Affected in this build (Yocto)</h3>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:220px">Package</th>
                  <th style="width:120px">Version</th>
                  <th style="width:200px">Layer</th>
                  <th style="width:110px">Status</th>
                  <th style="width:120px">Severity</th>
                </tr>
              </thead>
              <tbody id="cveYoctoBody"></tbody>
            </table>
          </div>

          <div style="height:14px"></div>

          <h3 class="panel-title">Developer tips</h3>
          <ul class="muted tips" id="cveTips"></ul>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
  // ===== Utilities =====
  const $ = (id)=>document.getElementById(id);
  const nowISO = ()=> new Date().toISOString();

  function esc(s){ return String(s ?? "").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
  function toNum(x){
    const n = Number(String(x ?? "").trim());
    return Number.isFinite(n) ? n : 0;
  }

  function severityFrom(issue){
    const v3 = toNum(issue.scorev3);
    const v2 = toNum(issue.scorev2);
    const s = v3 > 0 ? v3 : v2;
    if (s >= 9.0) return "Critical";
    if (s >= 7.0) return "High";
    if (s >= 4.0) return "Medium";
    if (s >  0.0) return "Low";
    return "None";
  }

  function sevColor(sev){
    switch(sev){
      case "Critical": return "rgba(255, 88, 120, 0.95)";
      case "High":     return "rgba(255, 170, 80, 0.95)";
      case "Medium":   return "rgba(120, 200, 255, 0.95)";
      case "Low":      return "rgba(140, 255, 180, 0.95)";
      default:         return "rgba(200, 200, 200, 0.85)";
    }
  }

  function sevBadge(sev){
    return `<span class="sevBadge"><span class="dot" style="background:${sevColor(sev)}"></span>${esc(sev)}</span>`;
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // CVSS pill class like NVD
  function cvssClass(score){
    const s = toNum(score);
    if (s === 0) return "score-none";
    if (s < 4.0) return "score-low";
    if (s < 7.0) return "score-med";
    if (s < 9.0) return "score-high";
    return "score-crit";
  }

  function withTimeout(promise, ms=9000){
    return Promise.race([
      promise,
      new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")), ms))
    ]);
  }

  // ===== Developer tips =====
  function developerTipsFor(r){
    const tips = [];
    tips.push("Verify the vulnerable component is actually shipped in the final image and reachable (runtime path, service exposure, feature enabled).");

    if (r.status === "Patched") {
      tips.push("Already marked Patched in Yocto CVE report. Confirm the patch/version is present in your build output and deployed image.");
      tips.push("If devices are deployed, schedule rollout/OTA so patched binaries land on targets.");
    } else if (r.status === "Unpatched") {
      tips.push("Preferred: upgrade the recipe/package to a version that includes the fix.");
      tips.push("If upgrade is risky, backport the upstream patch using a .bbappend (keep attribution; rebuild and retest).");
      tips.push("After applying fix: rebuild + re-run `bitbake <image> -c cve_check` to confirm it becomes Patched.");
    } else if (r.status === "Ignored") {
      tips.push("Ignored requires justification (not affected, mitigated, feature disabled, unreachable). Document this and get security sign-off.");
      tips.push("Re-check ignored CVEs when upgrading layers or enabling new features.");
    } else {
      tips.push("Review the CVE reference and assess whether your build configuration is affected.");
    }

    tips.push(`Yocto workflow: identify the recipe providing "${r.pkg}" (layer: ${r.layer || "unknown"}) and check version "${r.pkgVersion || "unknown"}".`);
    tips.push("If the vulnerable code is a dependency, check which recipe pulls it in and whether it can be updated or configured out.");
    tips.push("Validate fixes using SBOM + runtime scan (Syft/Grype) to ensure the deployed rootfs matches expectations.");
    tips.push("Prioritize network-facing Critical/High issues first; consider exposure and mitigations even when patching is delayed.");

    return tips;
  }

  // ===== State (Yocto) =====
  let yocto = null;
  let rows = [];
  let pkgIndex = [];
  let filtered = [];
  let sevChart = null;
  let pkgChart = null;

  // ===== State (CVE view) =====
  let lastTabBeforeCve = "issues";
  let currentCveId = null;

  // ===== State (SBOM) =====
  let sbom = null;
  let sbomComponents = [];
  let sbomDeps = new Map();
  let sbomFiltered = [];

  // ===== Charts =====
  function buildSevChart(counts){
    const labels = ["Critical","High","Medium","Low","None"];
    const data = labels.map(l=>counts[l] ?? 0);
    if (sevChart) sevChart.destroy();

    sevChart = new Chart($("sevChart"), {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: labels.map(sevColor),
          borderColor: "rgba(255,255,255,.18)",
          borderWidth: 1,
          hoverOffset: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        devicePixelRatio: window.devicePixelRatio || 1,
        cutout: "62%",
        rotation: -90,
        circumference: 360,
        plugins: {
          legend: { position: "top", labels: { color: "rgba(234,240,255,.85)", boxWidth: 14 } }
        }
      }
    });
  }

  function buildPkgChart(pkgCounts){
    const pairs = Object.entries(pkgCounts).sort((a,b)=>b[1]-a[1]).slice(0, 12);
    const labels = pairs.map(p=>p[0]);
    const data = pairs.map(p=>p[1]);
    if (pkgChart) pkgChart.destroy();

    pkgChart = new Chart($("pkgChart"), {
      type: "bar",
      data: { labels, datasets: [{ data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        devicePixelRatio: window.devicePixelRatio || 1,
        plugins: { legend: { display:false } },
        scales: {
          x: { ticks: { color:"rgba(234,240,255,.75)" }, grid: { color:"rgba(255,255,255,.06)" } },
          y: { ticks: { color:"rgba(234,240,255,.75)" }, grid: { color:"rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  // ===== Tabs =====
  function setTab(name, pushHash = true){
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.page===name));
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    const page = document.getElementById(`page-${name}`);
    if (page) page.classList.add("active");

    if (pushHash) {
      const newHash = `#${name}`;
      if (location.hash !== newHash) history.pushState({tab:name}, "", newHash);
    }
  }

  function applyHashTab(){
    const tab = (location.hash || "#summary").replace("#","");
    const allowed = new Set(["summary","packages","issues","sources","products","sbom","cve"]);
    setTab(allowed.has(tab) ? tab : "summary", false);
  }
  window.addEventListener("popstate", applyHashTab);
  window.addEventListener("hashchange", applyHashTab);

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>setTab(t.dataset.page, true));
  });

  // ===== Products & Fixes =====
  function renderProductsAndFixes(){
    if (!pkgIndex.length){
      $("productsBody").innerHTML = `<tr><td colspan="5" class="muted">No data loaded.</td></tr>`;
      return;
    }

    const byPkg = new Map();
    for (const r of rows){
      const arr = byPkg.get(r.pkg) || [];
      arr.push(r);
      byPkg.set(r.pkg, arr);
    }

    const sevRank = (p)=> (p.sevCounts.Critical*100000 + p.sevCounts.High*10000 + p.sevCounts.Medium*1000 + p.total);
    const list = [...pkgIndex].sort((a,b)=>sevRank(b)-sevRank(a));

    $("productsBody").innerHTML = list.map(p=>{
      const issues = (byPkg.get(p.name) || [])
        .sort((a,b)=>{
          const sa = Math.max(toNum(a.scorev3), toNum(a.scorev2));
          const sb = Math.max(toNum(b.scorev3), toNum(b.scorev2));
          return sb - sa;
        })
        .slice(0, 5)
        .map(x=>x.cve)
        .join(", ");

      const worstStatus =
        p.unpatched ? "Unpatched" :
        p.ignored   ? "Ignored"   :
        p.patched   ? "Patched"   : "—";

      return `
        <tr>
          <td><strong>${esc(p.name)}</strong></td>
          <td>${esc(p.version || "—")}</td>
          <td>${esc(p.layer || "—")}</td>
          <td>${esc(worstStatus)}</td>
          <td class="muted">${esc(issues || "—")}</td>
        </tr>
      `;
    }).join("");
  }

  function renderSources(){
    const list = rows.filter(r=>r.link);
    if (!list.length){
      $("sourcesBody").innerHTML = `<tr><td colspan="3" class="muted">No references present in this Yocto JSON.</td></tr>`;
      return;
    }
    $("sourcesBody").innerHTML = list.slice(0, 800).map(r=>`
      <tr>
        <td><strong>${esc(r.cve)}</strong></td>
        <td>${esc(r.pkg)}</td>
        <td><a class="link" href="${esc(r.link)}" target="_blank" rel="noopener">Open link</a></td>
      </tr>
    `).join("");
  }

  // ===== Yocto parsing =====
  function buildFromYocto(obj){
    yocto = obj;
    rows = [];
    pkgIndex = [];

    const pkgs = obj.package || [];
    const layerSet = new Set();

    let maxCvss3 = 0, maxCvss2 = 0;
    const vectorCounts = {};

    for (const p of pkgs){
      const pkgName = p.name ?? "unknown";
      const pkgLayer = p.layer ?? "";
      const pkgVer = p.version ?? "";
      layerSet.add(pkgLayer);

      const issues = Array.isArray(p.issue) ? p.issue : [];
      const sevCounts = {Critical:0,High:0,Medium:0,Low:0,None:0};
      let patched = 0, unpatched = 0, ignored = 0;

      for (const iss of issues){
        const sev = severityFrom(iss);
        sevCounts[sev] = (sevCounts[sev]||0)+1;

        const s3 = toNum(iss.scorev3); const s2 = toNum(iss.scorev2);
        if (s3 > maxCvss3) maxCvss3 = s3;
        if (s2 > maxCvss2) maxCvss2 = s2;

        const vec = (iss.vector || "").trim();
        if (vec) vectorCounts[vec] = (vectorCounts[vec]||0)+1;

        const status = iss.status ?? "";
        if (status === "Patched") patched++;
        else if (status === "Unpatched") unpatched++;
        else if (status === "Ignored") ignored++;

        rows.push({
          cve: iss.id ?? "UNKNOWN",
          summary: iss.summary ?? "",
          scorev2: iss.scorev2 ?? "",
          scorev3: iss.scorev3 ?? "",
          vector: iss.vector ?? "",
          status: status,
          link: iss.link ?? "",
          pkg: pkgName,
          pkgVersion: pkgVer,
          layer: pkgLayer,
          sev
        });
      }

      if (issues.length){
        pkgIndex.push({
          name: pkgName,
          version: pkgVer,
          layer: pkgLayer,
          total: issues.length,
          sevCounts,
          patched, unpatched, ignored
        });
      }
    }

    $("createdLine").textContent = `Report generated: ${nowISO()}`;
    $("pkgLine").textContent = `Packages: ${pkgs.length.toLocaleString()}`;
    $("issueLine").textContent = `Issues: ${rows.length.toLocaleString()}`;

    $("schemaV").textContent = String(obj.version ?? "—");
    $("affPkgs").textContent = new Set(rows.map(r=>r.pkg)).size.toLocaleString();
    $("totalIssues").textContent = rows.length.toLocaleString();
    const open = rows.filter(r => r.status === "Unpatched" || r.status === "Ignored").length;
    $("openIssues").textContent = open.toLocaleString();

    $("maxCvss3").textContent = maxCvss3 ? maxCvss3.toFixed(1) : "—";
    $("maxCvss2").textContent = maxCvss2 ? maxCvss2.toFixed(1) : "—";
    const commonVector = Object.entries(vectorCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "—";
    $("commonVector").textContent = commonVector;

    const patchedCnt = rows.filter(r=>r.status==="Patched").length;
    const unpatchedCnt = rows.filter(r=>r.status==="Unpatched").length;
    const ignoredCnt = rows.filter(r=>r.status==="Ignored").length;
    const uniqCves = new Set(rows.map(r=>r.cve)).size;

    $("execSummary").innerHTML = `
      <div class="muted">
        This is a local report generated from Yocto <code>cve-summary.json</code>. It includes
        <strong>${rows.length.toLocaleString()}</strong> CVE issues across
        <strong>${new Set(rows.map(r=>r.pkg)).size.toLocaleString()}</strong> affected packages
        (<strong>${uniqCves.toLocaleString()}</strong> unique CVE IDs).
        Status breakdown: <strong>${patchedCnt}</strong> patched, <strong>${unpatchedCnt}</strong> unpatched, <strong>${ignoredCnt}</strong> ignored.
      </div>
    `;

    const counts = {Critical:0,High:0,Medium:0,Low:0,None:0};
    const statusCounts = {Patched:0,Unpatched:0,Ignored:0};
    for (const r of rows){
      counts[r.sev] = (counts[r.sev]||0)+1;
      if (r.status in statusCounts) statusCounts[r.status]++;
    }

    const chips = [];
    chips.push(`<span class="chip info"><span class="dot" style="background:var(--info)"></span><strong>Schema</strong>: ${esc(obj.version ?? "—")}</span>`);
    chips.push(`<span class="chip bad"><span class="dot" style="background:${sevColor("Critical")}"></span><strong>Critical</strong>: ${counts.Critical}</span>`);
    chips.push(`<span class="chip warn"><span class="dot" style="background:${sevColor("High")}"></span><strong>High</strong>: ${counts.High}</span>`);
    chips.push(`<span class="chip"><span class="dot" style="background:${sevColor("Medium")}"></span><strong>Medium</strong>: ${counts.Medium}</span>`);
    chips.push(`<span class="chip good"><span class="dot" style="background:${sevColor("Low")}"></span><strong>Low</strong>: ${counts.Low}</span>`);
    chips.push(`<span class="chip good"><span class="dot" style="background:var(--good)"></span><strong>Patched</strong>: ${statusCounts.Patched}</span>`);
    chips.push(`<span class="chip warn"><span class="dot" style="background:var(--warn)"></span><strong>Unpatched</strong>: ${statusCounts.Unpatched}</span>`);
    chips.push(`<span class="chip"><span class="dot" style="background:rgba(200,200,200,.85)"></span><strong>Ignored</strong>: ${statusCounts.Ignored}</span>`);
    $("chipbar").innerHTML = chips.join("");

    buildSevChart(counts);
    const pkgCounts = {};
    for (const r of rows) pkgCounts[r.pkg] = (pkgCounts[r.pkg]||0)+1;
    buildPkgChart(pkgCounts);

    const top = [...rows].sort((a,b)=>{
      const rank = (sev)=> ({Critical:4,High:3,Medium:2,Low:1,None:0}[sev] ?? 0);
      const ra = rank(a.sev), rb = rank(b.sev);
      if (rb !== ra) return rb - ra;
      const sa = Math.max(toNum(a.scorev3), toNum(a.scorev2));
      const sb = Math.max(toNum(b.scorev3), toNum(b.scorev2));
      return sb - sa;
    }).slice(0, 12);

    $("topCvesBody").innerHTML = top.map(r=>`
      <tr data-cve="${esc(r.cve)}">
        <td><strong>${esc(r.cve)}</strong></td>
        <td>${sevBadge(r.sev)}</td>
        <td class="muted">${esc(r.summary || "")}</td>
        <td>${esc(r.status)}</td>
      </tr>
    `).join("");

    $("topCvesBody").querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const cve = tr.getAttribute("data-cve");
        openCveView(cve, "summary");
      });
    });

    const layerList = [...layerSet].filter(Boolean).sort();
    $("pkgLayerFilter").innerHTML =
      `<option value="">All layers</option>` + layerList.map(l=>`<option value="${esc(l)}">${esc(l)}</option>`).join("");
    renderPackagesList();

    $("q").value = ""; $("sevFilter").value=""; $("statusFilter").value="";
    filtered = [...rows];
    renderIssuesTable();

    renderProductsAndFixes();
    renderSources();

    applyHashTab();
  }

  // ===== Packages page =====
  function renderPackagesList(){
    const q = $("pkgSearch").value.trim().toLowerCase();
    const layer = $("pkgLayerFilter").value;

    let list = pkgIndex;
    if (layer) list = list.filter(p=>p.layer===layer);
    if (q) list = list.filter(p => (p.name||"").toLowerCase().includes(q) || (p.layer||"").toLowerCase().includes(q));

    const rank = (p)=> (p.sevCounts.Critical*100000 + p.sevCounts.High*10000 + p.total);
    list = [...list].sort((a,b)=>rank(b)-rank(a));

    $("pkgList").innerHTML = list.map(p=>{
      const sc = p.sevCounts;
      return `
        <div class="pkgCard" data-name="${esc(p.name)}">
          <div class="pkgTop">
            <div style="min-width:0;">
              <div class="pkgName">${esc(p.name)}</div>
              <div class="pkgMeta">version: ${esc(p.version || "—")} • layer: ${esc(p.layer || "—")} • issues: <strong>${p.total}</strong></div>
            </div>
            <div>${sevBadge(sc.Critical? "Critical": sc.High? "High": sc.Medium? "Medium": sc.Low? "Low":"None")}</div>
          </div>
          <div class="miniRow">
            <span class="miniPill" style="border-color:rgba(255,88,120,.35);color:#fecaca;">Critical: ${sc.Critical}</span>
            <span class="miniPill" style="border-color:rgba(255,170,80,.35);color:#fde68a;">High: ${sc.High}</span>
            <span class="miniPill" style="border-color:rgba(120,200,255,.35);color:#bfdbfe;">Medium: ${sc.Medium}</span>
            <span class="miniPill" style="border-color:rgba(140,255,180,.35);color:#bbf7d0;">Low: ${sc.Low}</span>
            <span class="miniPill">Patched: ${p.patched}</span>
            <span class="miniPill">Unpatched: ${p.unpatched}</span>
            <span class="miniPill">Ignored: ${p.ignored}</span>
          </div>
        </div>
      `;
    }).join("");

    document.querySelectorAll(".pkgCard").forEach(card=>{
      card.addEventListener("click", ()=>{
        const name = card.getAttribute("data-name");
        renderPackageDetails(name);
      });
    });
  }

  function renderPackageDetails(pkgName){
    const issues = rows.filter(r=>r.pkg===pkgName);
    if (!issues.length){
      $("pkgDetailPanel").innerHTML = `<h3 class="panel-title">Package Details</h3><div class="muted">No issues found.</div>`;
      return;
    }
    const pkgMeta = pkgIndex.find(p=>p.name===pkgName);
    const top = [...issues].sort((a,b)=>{
      const rank = (sev)=> ({Critical:4,High:3,Medium:2,Low:1,None:0}[sev] ?? 0);
      const ra = rank(a.sev), rb = rank(b.sev);
      if (rb !== ra) return rb - ra;
      const sa = Math.max(toNum(a.scorev3), toNum(a.scorev2));
      const sb = Math.max(toNum(b.scorev3), toNum(b.scorev2));
      return sb - sa;
    });

    $("pkgDetailPanel").innerHTML = `
      <h3 class="panel-title">Package Details</h3>
      <div class="muted"><strong>${esc(pkgName)}</strong> • version: ${esc(pkgMeta?.version || "—")} • layer: ${esc(pkgMeta?.layer || "—")} • issues: ${issues.length}</div>
      <div style="height:12px"></div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px">CVE</th>
              <th style="width:120px">Severity</th>
              <th>Summary</th>
              <th style="width:110px">Status</th>
              <th style="width:90px">CVSS</th>
            </tr>
          </thead>
          <tbody>
            ${top.slice(0, 50).map(r=>{
              const score = Math.max(toNum(r.scorev3), toNum(r.scorev2));
              return `
                <tr data-cve="${esc(r.cve)}">
                  <td><strong>${esc(r.cve)}</strong></td>
                  <td>${sevBadge(r.sev)}</td>
                  <td class="muted">${esc(r.summary || "")}</td>
                  <td>${esc(r.status)}</td>
                  <td>${score ? score.toFixed(1) : "—"}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:10px;">Showing up to 50 issues. Use the Issues tab for full search/export.</div>
    `;

    $("pkgDetailPanel").querySelectorAll("tr[data-cve]").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const cve = tr.getAttribute("data-cve");
        openCveView(cve, "packages");
      });
    });
  }

  // ===== Issues page =====
  function applyIssueFilters(){
    const q = $("q").value.trim().toLowerCase();
    const sevF = $("sevFilter").value;
    const stF  = $("statusFilter").value;

    filtered = rows.filter(r=>{
      if (sevF && r.sev !== sevF) return false;
      if (stF && r.status !== stF) return false;
      if (!q) return true;
      return (
        r.cve.toLowerCase().includes(q) ||
        r.pkg.toLowerCase().includes(q) ||
        (r.summary||"").toLowerCase().includes(q)
      );
    });

    renderIssuesTable();
  }

  function renderIssuesTable(){
    $("tbody").innerHTML = filtered.map(r=>`
      <tr data-cve="${esc(r.cve)}">
        <td><strong>${esc(r.cve)}</strong></td>
        <td>${sevBadge(r.sev)}</td>
        <td>${esc(r.pkg)}</td>
        <td>${esc(r.pkgVersion || "")}</td>
        <td>${esc(r.status || "")}</td>
      </tr>
    `).join("");

    $("tbody").querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const cve = tr.getAttribute("data-cve");
        openCveView(cve, "issues");
      });
    });
  }

  // ===== Full-page CVE view (GTI-like) =====
  function renderYoctoAffectedForCve(cveId){
    const list = rows.filter(r=>r.cve===cveId);
    if (!list.length){
      $("cveYoctoBody").innerHTML = `<tr><td colspan="5" class="muted">No affected packages for this CVE found in loaded Yocto JSON.</td></tr>`;
      return { status:"—", bestSev:"None", any:list.length };
    }

    const statusPriority = { "Unpatched": 3, "Ignored": 2, "Patched": 1 };
    const worstStatus = list.reduce((a,b)=>(statusPriority[b.status]||0) > (statusPriority[a]||0) ? b.status : a, "Patched");
    const sevPriority = { "Critical": 4, "High": 3, "Medium": 2, "Low": 1, "None": 0 };
    const bestSev = list.reduce((a,b)=> (sevPriority[b.sev] > sevPriority[a] ? b.sev : a), "None");

    $("cveYoctoBody").innerHTML = list.slice(0, 200).map(r=>`
      <tr>
        <td><strong>${esc(r.pkg)}</strong></td>
        <td>${esc(r.pkgVersion || "—")}</td>
        <td class="muted">${esc(r.layer || "—")}</td>
        <td>${esc(r.status || "—")}</td>
        <td>${sevBadge(r.sev)}</td>
      </tr>
    `).join("");

    return { status: worstStatus, bestSev, any:list.length };
  }

  function setCvssPill(score, label="CVSS"){
    const s = toNum(score);
    const pill = $("cveCvssPill");
    pill.className = `scorePill ${cvssClass(s)}`;
    pill.innerHTML = `<small>${esc(label)}</small> ${s ? s.toFixed(1) : "—"}`;
  }

  async function fetchNvd(cveId){
    // NVD API 2.0 (rate-limited without key, but OK for small usage)
    const url = `https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${encodeURIComponent(cveId)}`;
    const res = await withTimeout(fetch(url, {cache:"no-store"}), 12000);
    if (!res.ok) throw new Error("NVD fetch failed");
    return await res.json();
  }

  async function fetchEpss(cveId){
    const url = `https://api.first.org/data/v1/epss?cve=${encodeURIComponent(cveId)}`;
    const res = await withTimeout(fetch(url, {cache:"no-store"}), 10000);
    if (!res.ok) throw new Error("EPSS fetch failed");
    return await res.json();
  }

  function pickEnglishDescription(arr){
    if (!Array.isArray(arr)) return "";
    const en = arr.find(d=>d.lang==="en") || arr[0];
    return en?.value || "";
  }

  function extractCvssV31(metrics){
    // NVD v2.0 response format: metrics.cvssMetricV31 / cvssMetricV30 / cvssMetricV2
    const m = metrics?.cvssMetricV31?.[0] || metrics?.cvssMetricV30?.[0] || null;
    const cvss = m?.cvssData || null;
    return {
      score: cvss?.baseScore ?? null,
      vector: cvss?.vectorString ?? "",
      severity: cvss?.baseSeverity ?? ""
    };
  }

  function extractCvssV2(metrics){
    const m = metrics?.cvssMetricV2?.[0] || null;
    const cvss = m?.cvssData || null;
    return {
      score: cvss?.baseScore ?? null,
      vector: cvss?.vectorString ?? ""
    };
  }

  function renderRefs(refs){
    if (!Array.isArray(refs) || !refs.length) return "—";
    const top = refs.slice(0, 12).map(r=>{
      const u = r.url || "";
      return `<div style="margin:6px 0;"><a class="link" href="${esc(u)}" target="_blank" rel="noopener">${esc(u)}</a></div>`;
    }).join("");
    const more = refs.length > 12 ? `<div class="muted" style="margin-top:8px;">Showing 12 of ${refs.length} references.</div>` : "";
    return top + more;
  }

  async function openCveView(cveId, fromTab){
    currentCveId = cveId;
    lastTabBeforeCve = fromTab || "issues";

    // switch view
    setTab("cve");

    // reset UI fast (so it feels instant)
    $("cveTitle").textContent = cveId;
    $("cveSummary").textContent = "Loading…";
    $("cveDescription").textContent = "Loading…";
    $("cveRefs").textContent = "Loading…";
    $("cveMetaLine").textContent = "Published: — • Modified: — • EPSS: —";
    $("cveCvss3").textContent = "—";
    $("cveVector3").textContent = "—";
    $("cveCvss2").textContent = "—";
    $("cveEpss").textContent = "—";
    $("cveTips").innerHTML = "";
    $("cveNvdBtn").href = `https://nvd.nist.gov/vuln/detail/${encodeURIComponent(cveId)}`;

    // yocto affected
    const yo = renderYoctoAffectedForCve(cveId);
    $("cveYoctoStatus").textContent = yo.status || "—";
    // use Yocto CVSS if present (fallback)
    const yoRow = rows.find(r=>r.cve===cveId);
    const yoScore = yoRow ? (toNum(yoRow.scorev3) || toNum(yoRow.scorev2) || 0) : 0;
    setCvssPill(yoScore, "CVSS");
    const tips = yoRow ? developerTipsFor(yoRow) : ["Review NVD description and assess exposure in your build."];
    $("cveTips").innerHTML = tips.map(t=>`<li>${esc(t)}</li>`).join("");

    // fetch NVD + EPSS
    try{
      const [nvd, epss] = await Promise.allSettled([fetchNvd(cveId), fetchEpss(cveId)]);

      // EPSS
      let epssProb = null, epssPct = null;
      if (epss.status === "fulfilled"){
        const row = epss.value?.data?.[0];
        epssProb = row?.epss ? Number(row.epss) : null;
        epssPct = row?.percentile ? Number(row.percentile) : null;
        if (epssProb != null){
          $("cveEpss").textContent = `${(epssProb*100).toFixed(2)}%` + (epssPct!=null ? ` (p${(epssPct*100).toFixed(0)})` : "");
        }
      }

      // NVD
      if (nvd.status === "fulfilled"){
        const item = nvd.value?.vulnerabilities?.[0]?.cve;
        const pub = item?.published || "—";
        const mod = item?.lastModified || "—";
        const desc = pickEnglishDescription(item?.descriptions) || "—";
        const refs = item?.references || [];

        const cv31 = extractCvssV31(item?.metrics);
        const cv2 = extractCvssV2(item?.metrics);

        $("cveMetaLine").textContent =
          `Published: ${pub !== "—" ? new Date(pub).toISOString().slice(0,10) : "—"} • ` +
          `Modified: ${mod !== "—" ? new Date(mod).toISOString().slice(0,10) : "—"} • ` +
          `EPSS: ${epssProb!=null ? (epssProb*100).toFixed(2)+"%" : "—"}`;

        $("cveDescription").textContent = desc;

        // summary: short + practical
        const summary = desc.length > 220 ? desc.slice(0, 220).trim() + "…" : desc;
        $("cveSummary").textContent = summary || "—";

        // CVSS fields
        if (cv31.score != null){
          $("cveCvss3").textContent = Number(cv31.score).toFixed(1) + (cv31.severity ? ` (${cv31.severity})` : "");
          $("cveVector3").textContent = cv31.vector || "—";
          setCvssPill(cv31.score, "CVSS v3");
        } else {
          $("cveCvss3").textContent = "—";
          $("cveVector3").textContent = "—";
        }

        if (cv2.score != null){
          $("cveCvss2").textContent = Number(cv2.score).toFixed(1);
        } else {
          $("cveCvss2").textContent = "—";
        }

        $("cveRefs").innerHTML = renderRefs(refs);
      } else {
        $("cveSummary").textContent = "NVD details could not be loaded (rate limit or network).";
        $("cveDescription").textContent = "—";
        $("cveRefs").textContent = "—";
      }
    }catch(err){
      console.error(err);
      $("cveSummary").textContent = "Intel fetch failed (network or rate limit).";
      $("cveDescription").textContent = "—";
      $("cveRefs").textContent = "—";
    }
  }

  // ===== SBOM support (CycloneDX + SPDX basic) =====
  function detectSbomFormat(obj){
    if (obj && (obj.bomFormat === "CycloneDX" || Array.isArray(obj.components))) return "CycloneDX";
    if (obj && (obj.spdxVersion || Array.isArray(obj.packages))) return "SPDX";
    return "Unknown";
  }

  function normalizeCycloneDx(obj){
    const comps = (obj.components || []).map(c=>{
      const licenses = (c.licenses || []).map(l=>{
        if (l?.license?.id) return l.license.id;
        if (l?.license?.name) return l.license.name;
        if (l?.expression) return l.expression;
        return "";
      }).filter(Boolean);

      const purl = c.purl || "";
      const id = c["bom-ref"] || purl || `${c.name}@${c.version || ""}`;

      return {
        id,
        name: c.name || "unknown",
        version: c.version || "",
        purl,
        supplier: c.supplier?.name || "",
        licenses,
        description: c.description || ""
      };
    });

    const deps = new Map();
    for (const d of (obj.dependencies || [])){
      const ref = d.ref;
      const dependsOn = (d.dependsOn || []).map(x=>x).filter(Boolean);
      if (ref) deps.set(ref, dependsOn);
    }
    return { format:"CycloneDX", components: comps, deps };
  }

  function normalizeSpdx(obj){
    const packages = (obj.packages || []).map(p=>{
      const id = p.SPDXID || p.name || `pkg:${p.name || "unknown"}@${p.versionInfo || ""}`;
      const licenses = [p.licenseConcluded, p.licenseDeclared].map(x=>String(x||"").trim())
        .filter(x=>x && x !== "NOASSERTION" && x !== "NONE");
      return {
        id,
        name: p.name || "unknown",
        version: p.versionInfo || "",
        purl: "",
        supplier: String(p.supplier || "").replace(/^Organization:\s*/i,"").replace(/^Person:\s*/i,""),
        licenses,
        description: p.description || ""
      };
    });

    const deps = new Map();
    for (const rel of (obj.relationships || [])){
      const a = rel.spdxElementId;
      const b = rel.relatedSpdxElement;
      const t = rel.relationshipType;
      if (!a || !b) continue;
      if (t === "DEPENDS_ON" || t === "CONTAINS" || t === "DYNAMIC_LINK" || t === "STATIC_LINK"){
        const arr = deps.get(a) || [];
        arr.push(b);
        deps.set(a, arr);
      }
    }

    return { format:"SPDX", components: packages, deps };
  }

  function buildSbomFromObject(obj){
    const fmt = detectSbomFormat(obj);
    if (fmt === "CycloneDX") return normalizeCycloneDx(obj);
    if (fmt === "SPDX") return normalizeSpdx(obj);
    return { format:"Unknown", components: [], deps: new Map() };
  }

  function sbomTopLicenses(list){
    const counts = {};
    for (const c of list){
      for (const l of (c.licenses || [])){
        counts[l] = (counts[l] || 0) + 1;
      }
    }
    const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, 3);
    if (!top.length) return "—";
    return top.map(([k,v])=>`${k} (${v})`).join(", ");
  }

  function sbomPopulateLicenseFilter(){
    const set = new Set();
    for (const c of sbomComponents){
      for (const l of (c.licenses || [])) set.add(l);
    }
    const arr = [...set].sort();
    $("sbomLicFilter").innerHTML = `<option value="">All licenses</option>` +
      arr.map(l=>`<option value="${esc(l)}">${esc(l)}</option>`).join("");
  }

  function applySbomFilters(){
    const q = $("sbomQ").value.trim().toLowerCase();
    const licF = $("sbomLicFilter").value;

    sbomFiltered = sbomComponents.filter(c=>{
      if (licF){
        const has = (c.licenses || []).includes(licF);
        if (!has) return false;
      }
      if (!q) return true;

      const hay = [
        c.name, c.version, c.purl, c.supplier, (c.licenses||[]).join(" "), c.description
      ].join(" ").toLowerCase();

      return hay.includes(q);
    });

    renderSbomTable();
  }

  function renderSbomMeta(){
    $("sbomFormat").textContent = sbom?.format || "—";
    $("sbomCompCount").textContent = (sbomComponents.length || 0).toLocaleString();

    let edges = 0;
    for (const v of sbomDeps.values()) edges += v.length;
    $("sbomDepCount").textContent = edges.toLocaleString();
    $("sbomTopLic").textContent = sbomTopLicenses(sbomComponents);
  }

  function renderSbomTable(){
    const tb = $("sbomTbody");
    if (!sbomComponents.length){
      tb.innerHTML = `<tr><td colspan="3" class="muted">Load an SBOM JSON to populate this view.</td></tr>`;
      return;
    }

    const list = sbomFiltered.length ? sbomFiltered : sbomComponents;

    tb.innerHTML = list.slice(0, 2000).map(c=>{
      const lic = (c.licenses && c.licenses.length) ? c.licenses[0] : "—";
      return `
        <tr data-sbom-id="${esc(c.id)}">
          <td>
            <strong>${esc(c.name)}</strong>
            ${c.purl ? `<div class="muted mono" style="margin-top:4px;">${esc(c.purl)}</div>` : ""}
          </td>
          <td>${esc(c.version || "—")}</td>
          <td class="muted">${esc(lic)}</td>
        </tr>
      `;
    }).join("");

    tb.querySelectorAll("tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const id = tr.getAttribute("data-sbom-id");
        const c = sbomComponents.find(x=>x.id === id);
        if (c) renderSbomDetails(c);
      });
    });
  }

  function renderSbomDetails(c){
    const deps = sbomDeps.get(c.id) || [];
    const depItems = deps.slice(0, 40).map(did=>{
      const dc = sbomComponents.find(x=>x.id === did);
      const label = dc ? `${dc.name}${dc.version ? "@" + dc.version : ""}` : did;
      return `<li class="mono">${esc(label)}</li>`;
    }).join("");

    const licPills = (c.licenses || []).slice(0, 8).map(l=>`<span class="chip">${esc(l)}</span>`).join("") || `<span class="chip">—</span>`;

    $("sbomDetailsPanel").innerHTML = `
      <h3 class="panel-title">Component Details</h3>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <div style="font-weight:900;font-size:16px;">${esc(c.name)}</div>
        ${c.version ? `<span class="chip"><strong>Version</strong>: ${esc(c.version)}</span>` : ""}
      </div>

      <div class="muted" style="margin-top:8px;">
        ID: <span class="mono">${esc(c.id)}</span>
      </div>

      ${c.supplier ? `<div class="muted" style="margin-top:6px;">Supplier: <strong>${esc(c.supplier)}</strong></div>` : ""}
      ${c.description ? `<div class="muted" style="margin-top:10px;">${esc(c.description)}</div>` : ""}

      <div style="height:12px"></div>
      <h3 class="panel-title">Licenses</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">${licPills}</div>

      <div style="height:14px"></div>
      <h3 class="panel-title">Dependencies</h3>
      <div class="muted">${deps.length ? `Depends on <strong>${deps.length}</strong> components (showing up to 40):` : "No dependency info available in this SBOM."}</div>
      ${deps.length ? `<ul class="muted tips">${depItems}</ul>` : ""}
    `;
  }

  function clearSbom(){
    sbom = null;
    sbomComponents = [];
    sbomDeps = new Map();
    sbomFiltered = [];
    $("sbomFormat").textContent = $("sbomCompCount").textContent = $("sbomDepCount").textContent = $("sbomTopLic").textContent = "—";
    $("sbomLicFilter").innerHTML = `<option value="">All licenses</option>`;
    $("sbomQ").value = "";
    $("sbomTbody").innerHTML = `<tr><td colspan="3" class="muted">Load an SBOM JSON to populate this view.</td></tr>`;
    $("sbomDetailsPanel").innerHTML = `<h3 class="panel-title">Component Details</h3><div class="muted">Click a component row to view details and dependencies.</div>`;
    $("sbomFile").value = "";
  }

  // ===== Events =====
  $("file").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const text = await f.text();
    const obj = JSON.parse(text);

    if (!obj || !Array.isArray(obj.package)){
      alert("This doesn't look like Yocto cve-summary.json (expected top-level { package: [...] }).");
      return;
    }
    buildFromYocto(obj);
  });

  $("sbomFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;

    try{
      const text = await f.text();
      const obj = JSON.parse(text);

      sbom = buildSbomFromObject(obj);
      sbomComponents = sbom.components || [];
      sbomDeps = sbom.deps || new Map();
      sbomFiltered = [];

      renderSbomMeta();
      sbomPopulateLicenseFilter();
      applySbomFilters();

      setTab("sbom");
    }catch(err){
      console.error(err);
      alert("Failed to parse SBOM JSON. Please upload a valid CycloneDX or SPDX JSON file.");
    }
  });

  $("sbomClearBtn").addEventListener("click", clearSbom);

  $("cveBackBtn").addEventListener("click", ()=>{
    setTab(lastTabBeforeCve || "issues");
  });

  $("cveRefreshBtn").addEventListener("click", ()=>{
    if (currentCveId) openCveView(currentCveId, "cve");
  });

  $("resetBtn").addEventListener("click", ()=>{
    yocto=null; rows=[]; pkgIndex=[]; filtered=[];
    $("reportTitle").textContent = "VulnTrack Report";
    $("createdLine").textContent = "Report generated: —";
    $("pkgLine").textContent = "Packages: —";
    $("issueLine").textContent = "Issues: —";
    $("chipbar").innerHTML = `<span class="chip">Load <strong>cve-summary.json</strong> to view</span>`;
    $("schemaV").textContent = $("affPkgs").textContent = $("totalIssues").textContent = $("openIssues").textContent = "—";
    $("maxCvss3").textContent = $("maxCvss2").textContent = $("commonVector").textContent = "—";
    $("topCvesBody").innerHTML = "";
    $("pkgList").innerHTML = "";
    $("pkgDetailPanel").innerHTML = `<h3 class="panel-title">Package Details</h3><div class="muted">Select a package to see its issues.</div>`;
    $("tbody").innerHTML = "";
    $("detailsPanel").innerHTML = `<h3 class="panel-title">Issue Details</h3><div class="muted">Click an issue row to view details.</div><div class="muted" style="margin-top:10px;">Tip: Click any row to open the full CVE view.</div>`;
    $("q").value=""; $("sevFilter").value=""; $("statusFilter").value="";
    $("pkgSearch").value=""; $("pkgLayerFilter").innerHTML = `<option value="">All layers</option>`;
    $("productsBody").innerHTML = `<tr><td colspan="5" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>`;
    $("sourcesBody").innerHTML  = `<tr><td colspan="3" class="muted">Load <strong>cve-summary.json</strong> to populate this view.</td></tr>`;

    if (sevChart) sevChart.destroy();
    if (pkgChart) pkgChart.destroy();
    sevChart = pkgChart = null;

    clearSbom();

    history.pushState({tab:"summary"}, "", "#summary");
    setTab("summary", false);

    $("file").value="";
  });

  ["q","sevFilter","statusFilter"].forEach(id=>{
    $(id).addEventListener("input", applyIssueFilters);
    $(id).addEventListener("change", applyIssueFilters);
  });

  ["sbomQ","sbomLicFilter"].forEach(id=>{
    $(id).addEventListener("input", applySbomFilters);
    $(id).addEventListener("change", applySbomFilters);
  });

  $("csvBtn").addEventListener("click", ()=>{
    if (!filtered.length){ alert("No rows to export."); return; }
    const header = ["cve","severity","package","package_version","layer","status","scorev3","scorev2","vector","link","summary"];
    const lines = [header.join(",")];
    for (const r of filtered){
      const row = [
        r.cve, r.sev, r.pkg, r.pkgVersion, r.layer, r.status, r.scorev3, r.scorev2, r.vector, r.link, r.summary
      ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`);
      lines.push(row.join(","));
    }
    downloadText("yocto-filtered-cves.csv", lines.join("\n"));
  });

  $("pkgSearch").addEventListener("input", renderPackagesList);
  $("pkgLayerFilter").addEventListener("change", renderPackagesList);

  // Initialize tab state on first load
  if (!location.hash) history.replaceState({tab:"summary"}, "", "#summary");
  applyHashTab();
</script>

</body>
</html>

